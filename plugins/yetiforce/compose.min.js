'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

window.rcmail&&rcmail.addEventListener('init',function(){function getEmailAddresses(responseData,e,module){var aDeferred=$.Deferred(),emails=[];return 'undefined'!=typeof e.target&&('email'===$(e.target).data('type')||'multiEmail'===$(e.target).data('type'))?(emails.push($(e.target).text()),aDeferred.resolve(emails)):function(){var i=0;for(var id in responseData)window.crm.app.getRecordDetails({record:id,module:module,fieldType:['email','multiEmail']}).done(function(data){i++,emails.push(getFirstEmailAddress(data.result.data)),i===Object.keys(responseData).length&&aDeferred.resolve(emails);});}(),aDeferred.promise()}function getFirstEmailAddress(mailObj){var emails=[];for(var key in mailObj)if(mailObj[key])if(window.crm.app.isJsonString(mailObj[key])){var multiEmail=JSON.parse(mailObj[key]);for(var i in multiEmail)emails.push(multiEmail[i].e);break}else{emails.push(mailObj[key]);break}return emails}var crm=window.crm=getCrmWindow(),crmPath=rcmail.env.site_URL+'index.php?';rcmail.env.compose_commands.push('yetiforce.addFilesToMail'),rcmail.env.compose_commands.push('yetiforce.addFilesFromCRM'),rcmail.register_command('yetiforce.addFilesToMail',function(data){var ts=new Date().getTime(),frame=rcmail.async_upload_form_frame('rcmupload'+ts);data._uploadid=ts,jQuery.ajax({url:'?_task=mail&_action=plugin.yetiforce.addFilesToMail&_id='+rcmail.env.compose_id,type:'POST',data:data,success:function success(data){var doc=frame[0],body=$(doc);body.html(data);}});},!0),rcmail.register_command('yetiforce.addFilesFromCRM',function(){!1!=crm&&window.crm.app.showRecordsList({module:'Documents',src_module:'Documents',multi_select:!0,additionalInformations:!0},function(modal,instance){instance.setSelectEvent(function(responseData){rcmail.command('yetiforce.addFilesToMail',{ids:Object.keys(responseData),_uploadid:new Date().getTime()});});});},!0),$('#composeheaders #yt_adress_buttons .button').click(function(){var mailField=$(this).attr('data-input'),module=$(this).attr('data-module');window.crm.app.showRecordsList({module:module,src_module:'OSSMail',multi_select:!0,additionalInformations:!0},function(modal,instance){instance.setSelectEvent(function(responseData,e){getEmailAddresses(responseData,e,module).done(function(emails){if(emails.length){var value=$('#'+mailField).val();''!=value&&','!=value.charAt(value.length-1)&&(value+=','),$('#'+mailField).val(value+emails.join(','));}else window.crm.Vtiger_Helper_Js.showPnotify({text:window.crm.app.vtranslate('NoFindEmailInRecord'),animation:'show'});});});});}),rcmail.env.isPermittedMailTemplates&&jQuery.ajax({type:'Get',url:'?_task=mail&_action=plugin.yetiforce.getEmailTemplates&_id='+rcmail.env.compose_id,async:!1,success:function success(data){var modules=[],tmp=[];data=JSON.parse(data),$.each(data,function(index,value){jQuery('#vtmodulemenulink').removeClass('disabled'),jQuery('#tplmenulink').removeClass('disabled'),tmp.push({name:value.moduleName,label:value.moduleName}),jQuery('#tplmenu #texttplsmenu').append('<li class="'+value.moduleName+'"><a href="#" data-module="'+value.module+'" data-tplid="'+value.id+'" class="active">'+value.name+'</a></li>');}),$.each(tmp,function(index,value){-1==jQuery.inArray(value.name,modules)&&(jQuery('#vtmodulemenu .toolbarmenu').append('<li class="'+value.name+'"><a href="#" data-module="'+value.name+'" class="active">'+value.label+'</a></li>'),modules.push(value.name));});}}),jQuery('#vtmodulemenu li a').on('click',function(){var selectModule=jQuery(this).data('module');selectModule==null?jQuery('#tplmenu li').show():(jQuery('#tplmenu li.'+selectModule).show(),jQuery('#tplmenu li').not('.'+selectModule).hide());}),rcmail.env.crmModule!=null&&jQuery('#vtmodulemenu li.'+rcmail.env.crmModule+' a').trigger('click'),jQuery('#tplmenu  li a').on('click',function(){var id=jQuery(this).data('tplid'),recordId=rcmail.env.crmRecord,module=rcmail.env.crmModule,view=rcmail.env.crmView;if('List'==view){var chElement=jQuery(crm.document).find('.listViewEntriesCheckBox')[0];recordId=jQuery(chElement).val();}jQuery.ajax({type:'Get',url:'?_task=mail&_action=plugin.yetiforce.getConntentEmailTemplate&_id='+rcmail.env.compose_id,data:{id:id,record_id:recordId,select_module:module},success:function success(data){data=JSON.parse(data);var oldSubject=jQuery('[name="_subject"]').val(),html=jQuery('<div/>').html(data.content).html(),ed='';if(jQuery('[name="_subject"]').val(oldSubject+' '+data.subject),window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))){var oldBody=tinyMCE.activeEditor.getContent();tinymce.activeEditor.setContent(html+oldBody);}else{var _oldBody=jQuery('#composebody').val();jQuery('#composebody').val(html+_oldBody);}'undefined'!=typeof data.attachments&&null!==data.attachments&&rcmail.command('yetiforce.addFilesToMail',data.attachments);}});});});function getCrmWindow(){if(null!==opener)return opener.parent;return !('object'!=_typeof(parent.app))&&parent}
//# sourceMappingURL=compose.min.js.map
