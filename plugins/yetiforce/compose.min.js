'use strict';

'use strict';/* {[The file is published on the basis of MIT License]} */function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}//Document selection
//Add files to mail
// Select template
window.rcmail&&rcmail.addEventListener("init",function(){rcmail.crm=rcmail.getCrmWindow(),!1!=rcmail.crm&&(rcmail.env.compose_commands.push("yetiforce.addFilesFromCRM"),rcmail.env.compose_commands.push("yetiforce.selectTemplate"),rcmail.env.compose_commands.push("yetiforce.selectAdress"),rcmail.register_command("yetiforce.addFilesFromCRM",function(){rcmail.addFilesFromCRM();},!0),rcmail.register_command("yetiforce.selectTemplate",function(){rcmail.selectTemplate();},!0),rcmail.register_command("yetiforce.selectAdress",function(module,part){rcmail.selectAdress(module,part);},!0));}),rcube_webmail.prototype.addFilesFromCRM=function(){rcmail.crm.app.showRecordsList({module:"Documents",src_module:"Documents",multi_select:!0,additionalInformations:!0,search_params:[[["filelocationtype","e","I"]]]},function(modal,instance){instance.setSelectEvent(function(responseData){rcmail.addFilesToMail({ids:Object.keys(responseData)});});});},rcube_webmail.prototype.addFilesToMail=function(data){data._id=rcmail.env.compose_id,data._uploadid=new Date().getTime(),this.http_post("plugin.yetiforce-addFilesToMail",data,this.set_busy(!0,"loading"));},rcube_webmail.prototype.selectTemplate=function(){rcmail.crm.app.showRecordsList({module:"EmailTemplates",src_module:"EmailTemplates",search_params:"[[[\"email_template_type\",\"e\",\"PLL_MAIL\"]]]"},function(modal,instance){instance.setSelectEvent(function(responseData){var recordId=rcmail.env.yf_crmRecord,module=rcmail.env.yf_crmModule,view=rcmail.env.yf_crmView;if("List"==view){var chElement=jQuery(crm.document).find(".listViewEntriesCheckBox")[0];recordId=jQuery(chElement).val();}jQuery.ajax({type:"Get",url:"?_task=mail&_action=plugin.yetiforce-getContentEmailTemplate&_id="+rcmail.env.compose_id,data:{id:responseData.id,record_id:recordId,select_module:module},dataType:"json",success:function success(data){var oldSubject=jQuery("[name=\"_subject\"]").val(),html=jQuery("<div/>").html(data.content).html(),ed="";if(jQuery("[name=\"_subject\"]").val(oldSubject+" "+data.subject),window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))){var oldBody=tinyMCE.activeEditor.getContent();tinymce.activeEditor.setContent(html+oldBody);}else {var _oldBody=jQuery("#composebody").val();jQuery("#composebody").val(html+_oldBody);}"undefined"!=typeof data.attachments&&null!==data.attachments&&rcmail.addFilesToMail(data.attachments);}});});});},rcube_webmail.prototype.selectAdress=function(module,part){rcmail.crm.app.showRecordsList({module:module,src_module:"OSSMail",multi_select:!0,additionalInformations:!1},function(modal,instance){instance.setSelectEvent(function(responseData,e){rcmail.getEmailAddresses(responseData,e,module).done(function(emails){if(emails.length){var paetElement=$("#"+part),value=paetElement.val();""!=value&&","!=value.charAt(value.length-1)&&(value+=","),paetElement.val(value+emails.join(",")),paetElement.change();}else rcmail.crm.app.showNotify({text:rcmail.crm.app.vtranslate("NoFindEmailInRecord"),animation:"show"});});});});},rcube_webmail.prototype.getEmailAddresses=function(responseData,e,module){var aDeferred=$.Deferred(),emails=[],label="",email="";return "undefined"!=typeof e.target&&("email"===$(e.target).data("type")||"multiEmail"===$(e.target).data("type"))?(emails.push($(e.target).text()),aDeferred.resolve(emails)):function(){var i=0,_loop=function(id){rcmail.crm.app.getRecordDetails({record:id,module:module,fieldType:["email","multiEmail"]}).done(function(data){i++,label=email=rcmail.getFirstEmailAddress(data.result.data),responseData[id]&&(label=responseData[id]),emails.push(label+"<"+email+">"),i===Object.keys(responseData).length&&aDeferred.resolve(emails);});};for(var id in responseData)_loop(id);}(),aDeferred.promise()},rcube_webmail.prototype.getFirstEmailAddress=function(data){var emails=[];for(var key in data)if(data[key])if(rcmail.crm.app.isJsonString(data[key])){var multiEmail=JSON.parse(data[key]);for(var i in multiEmail)emails.push(multiEmail[i].e);break}else {emails.push(data[key]);break}return emails},rcube_webmail.prototype.getCrmWindow=function(){if(null!==opener&&"object"==_typeof(opener.parent.CONFIG))return opener.parent;return "object"==_typeof(parent.CONFIG)?parent:"object"==_typeof(parent.opener.CONFIG)?parent.opener:"object"==_typeof(parent.parent.CONFIG)?parent.parent:!("object"!=_typeof(opener.crm.CONFIG))&&opener.crm};
//# sourceMappingURL=compose.min.js.map
