'use strict';

"use strict";/* {[The file is published on the basis of MIT License]} */function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}// import ICS file action
// Get raw mail body
//Show mail analysis modal
window.rcmail&&rcmail.addEventListener("init",function(){rcmail.crm=rcmail.getCrmWindow();!1===rcmail.crm||(rcmail.env.uid&&rcmail.loadActionBar(),rcmail.env.message_commands.push("yetiforce.importICS"),rcmail.register_command("yetiforce.importICS",function(props,type){rcmail.importICS(props,type);},!0),rcmail.register_command("plugin.yetiforce.loadMailAnalysis",function(props){rcmail.loadMailAnalysis(props);},rcmail.env.uid),rcmail.addEventListener("plugin.yetiforce.showMailAnalysis",function(content){rcmail.showMailAnalysis(content);}),rcmail.message_list&&rcmail.message_list.addEventListener("select",function(list){rcmail.enable_command("plugin.yetiforce.loadMailAnalysis",0<list.get_selection(!1).length);}));}),rcube_webmail.prototype.importICS=function(part,type){this.http_post("plugin.yetiforce-importIcs",{_mbox:rcmail.env.mailbox,_uid:rcmail.env.uid,_part:part,_type:type,_mailId:this.mailId},this.set_busy(!0,"loading"));},rcube_webmail.prototype.loadActionBar=function(){this.crmContent=$("#ytActionBarContent"),rcmail.crm.AppConnector.request({module:"OSSMail",view:"MailActionBar",uid:rcmail.env.uid,folder:rcmail.env.mailbox,rcId:rcmail.env.user_id}).done(function(response){rcmail.crmContent.find(".ytHeader").html(response),$("#messagecontent").css("top",rcmail.crmContent.outerHeight()+$("#messageheader").outerHeight()+"px"),rcmail.registerEvents();});},rcube_webmail.prototype.registerEvents=function(){this.mailId=this.crmContent.find("#mailActionBarID").val(),this.registerAddRecord(),this.registerAddReletedRecord(),this.registerAddAttachments(),this.registerSelectRecord(),this.registerRemoveRecord(),this.registerImportMail(),rcmail.crm.app.registerPopover(this.crmContent.closest("body")),rcmail.crm.app.registerIframeAndMoreContent(this.crmContent.closest("body"));var block=this.crmContent.find(".ytHeader .js-data");this.crmContent.find(".hideBtn").click(function(){var button=$(this),icon=button.find("span");"0"==button.data("type")?(button.data("type","1"),icon.removeClass("fa-chevron-circle-up").addClass("fa-chevron-circle-down")):(button.data("type","0"),icon.removeClass("fa-chevron-circle-down").addClass("fa-chevron-circle-up")),block.toggle(),$(window).trigger("resize");});},rcube_webmail.prototype.registerImportMail=function(){var clicked=!1,importButton=rcmail.crmContent.find(".js-importMail");importButton.click(function(){return !clicked&&void(clicked=!0,importButton.addClass("d-none"),rcmail.crm.app.showNotify({text:rcmail.crm.app.vtranslate("StartedDownloadingEmail"),type:"info"}),rcmail.crm.AppConnector.request({module:"OSSMail",action:"ImportMail",uid:rcmail.env.uid,folder:rcmail.env.mailbox,rcId:rcmail.env.user_id}).done(function(data){rcmail.loadActionBar(),data.result?rcmail.crm.app.showNotify({text:rcmail.crm.app.vtranslate("AddFindEmailInRecord"),type:"success"}):rcmail.crm.app.showNotify({text:rcmail.crm.app.vtranslate("JS_UNEXPECTED_ERROR"),type:"error"});}).fail(function(){clicked=!1;}))});},rcube_webmail.prototype.registerAddAttachments=function(){rcmail.crmContent.find("button.addAttachments").click(function(e){var row=$(e.currentTarget).closest(".rowRelatedRecord"),relatedModule=row.data("module"),relatedRecordId=row.data("id");rcmail.crm.app.showRecordsList({module:"Documents",related_parent_module:"OSSMailView",related_parent_id:rcmail.mailId,multi_select:!0,record_selected:!0},function(modal,instance){instance.setSelectEvent(function(responseData){rcmail.crm.AppConnector.request({async:!1,dataType:"json",data:{module:relatedModule,action:"RelationAjax",mode:"addRelation",related_module:"Documents",src_record:relatedRecordId,related_record_list:JSON.stringify(Object.keys(responseData))}}).done(function(data){var notifyParams={text:rcmail.crm.app.vtranslate("JS_DOCUMENTS_ADDED"),type:"success",animation:"show"};data.success||(notifyParams.type="error",notifyParams.text=rcmail.crm.app.vtranslate("JS_ERROR")),rcmail.crm.app.showNotify(notifyParams);});});});});},rcube_webmail.prototype.registerRemoveRecord=function(){rcmail.crmContent.find("button.removeRecord").click(function(e){rcmail.removeRecord($(e.currentTarget).closest(".rowRelatedRecord").data("id"));});},rcube_webmail.prototype.registerSelectRecord=function(){rcmail.crmContent.find("button.selectRecord").click(function(){var relationSelect=rcmail.crmContent.find("#addRelationSelect").val(),getCacheModule=rcmail.crm.app.moduleCacheGet("selectedModuleName");("undefined"===getCacheModule||relationSelect!==getCacheModule)&&rcmail.crm.app.moduleCacheSet("selectedModuleName",relationSelect);var relParams={mailId:rcmail.mailId};if(0==$(this).data("type")){var module=$(this).closest(".js-head-container").find(".module").val();if(null===module)return}else {var module=$(this).data("module");relParams.crmid=$(this).closest(".rowRelatedRecord").data("id"),relParams.mod=$(this).closest(".rowRelatedRecord").data("module"),relParams.newModule=module;}rcmail.showPopup({module:module,src_module:"OSSMailView",src_record:rcmail.mailId},relParams);});},rcube_webmail.prototype.registerAddReletedRecord=function(){rcmail.crmContent.find("button.addRelatedRecord").click(function(e){var targetElement=$(e.currentTarget),row=targetElement.closest(".rowRelatedRecord");rcmail.showQuickCreateForm(targetElement.data("module"),row.data("id"),{sourceModule:row.data("module")});});},rcube_webmail.prototype.registerAddRecord=function(){var getCacheModule=rcmail.crm.app.moduleCacheGet("selectedModuleName");getCacheModule&&rcmail.crmContent.find("#addRelationSelect").val(getCacheModule),rcmail.crmContent.find("button.addRecord").click(function(e){var relationSelect=rcmail.crmContent.find("#addRelationSelect").val();("undefined"===getCacheModule||relationSelect!==getCacheModule)&&rcmail.crm.app.moduleCacheSet("selectedModuleName",relationSelect);var col=$(e.currentTarget).closest(".js-head-container"),selectValue=col.find(".module").val();if(null!==selectValue){var relatedRecords=[];rcmail.crmContent.find(".js-data").find(".rowRelatedRecord").each(function(i,record){var data=$(record).data();relatedRecords.push({module:data.module,id:data.id});}),rcmail.showQuickCreateForm(selectValue,rcmail.mailId,{relatedRecords:relatedRecords});}});},rcube_webmail.prototype.removeRecord=function(crmid){rcmail.crm.AppConnector.request({async:!1,dataType:"json",data:{module:"OSSMail",action:"ExecuteActions",mode:"removeRelated",params:{mailId:rcmail.mailId,crmid:crmid}}}).done(function(data){var response=data.result,notifyParams={text:response.data,animation:"show"};response.success&&(notifyParams={text:response.data,type:"info",animation:"show"}),rcmail.crm.app.showNotify(notifyParams),rcmail.loadActionBar();});},rcube_webmail.prototype.showPopup=function(params,actionsParams){actionsParams.newModule=params.module,rcmail.crm.app.showRecordsList(params,function(modal,instance){instance.setSelectEvent(function(responseData){actionsParams.newCrmId=responseData.id,rcmail.crm.AppConnector.request({async:!1,dataType:"json",data:{module:"OSSMail",action:"ExecuteActions",mode:"addRelated",params:actionsParams}}).done(function(data){var response=data.result;if(response.success)var notifyParams={text:response.data,type:"info",animation:"show"};else var notifyParams={text:response.data,animation:"show"};rcmail.crm.app.showNotify(notifyParams),rcmail.loadActionBar();});});});},rcube_webmail.prototype.showQuickCreateForm=function(moduleName,record){var params=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},relatedParams={},sourceModule="OSSMailView";params.sourceModule&&(sourceModule=params.sourceModule);var ids={link:"modulesLevel0",process:"modulesLevel1",subprocess:"modulesLevel2",subprocess_sl:"modulesLevel3",linkextend:"modulesLevel4"};for(var i in ids){var element=rcmail.crmContent.find("#"+ids[i]),value=element.length?JSON.parse(element.val()):[];0<=$.inArray(sourceModule,value)&&(relatedParams[i]=record);}var fillNameFields=function fillNameFields(first){var nameData=rcmail.env.yf_fromName.split(" "),firstName=nameData.shift(),lastName=nameData.join(" ");return first?firstName:lastName},autoCompleteMapRaw=rcmail.crmContent.find(".js-mailAutoCompleteFields").val(),autoCompleteMap=autoCompleteMapRaw?JSON.parse(autoCompleteMapRaw):[];if(autoCompleteMap&&autoCompleteMap[moduleName]){var map=autoCompleteMap[moduleName];for(var name in map)if(map.hasOwnProperty(name)&&map[name])switch(map[name]){case"fromNameFirstPart":relatedParams[name]=fillNameFields(!0);break;case"fromNameSecondPart":relatedParams[name]=fillNameFields(!1);break;case"fromName":relatedParams[name]=rcmail.env.yf_fromName;break;case"subject":relatedParams[name]=rcmail.env.yf_subject;break;case"email":relatedParams[name]=rcmail.env.yf_fromMail;}}relatedParams.email=rcmail.env.yf_fromMail,relatedParams.email1=rcmail.env.yf_fromMail;var messageBody=$("#messagebody .rcmBody").clone();messageBody.find(".image-attachment").remove(),relatedParams.description=messageBody.html(),params.relatedRecords!==void 0&&(relatedParams.relatedRecords=params.relatedRecords),relatedParams.sourceModule=sourceModule,relatedParams.sourceRecord=record,relatedParams.relationOperation=!0,rcmail.crm.App.Components.QuickCreate.createRecord(moduleName,{callbackFunction:function callbackFunction(data){rcmail.loadActionBar();},callbackPostShown:function postShown(data){$("<input type=\"hidden\" name=\"sourceModule\" value=\""+sourceModule+"\" />").appendTo(data),$("<input type=\"hidden\" name=\"sourceRecord\" value=\""+record+"\" />").appendTo(data),$("<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />").appendTo(data);},data:relatedParams,noCache:!0});},rcube_webmail.prototype.getCrmWindow=function(){if(null!==opener&&"object"==opener.parent.CONFIG)return opener.parent;return "object"==_typeof(parent.CONFIG)?parent:"object"==_typeof(parent.parent.CONFIG)?parent.parent:!(null===opener||"object"!=_typeof(opener.crm.CONFIG))&&opener.crm},rcube_webmail.prototype.loadMailAnalysis=function(props){this.http_post("plugin.yetiforce-loadMailAnalysis",this.selection_post_data(),this.set_busy(!0,"loading"));},rcube_webmail.prototype.showMailAnalysis=function(content){var progressIndicatorElement=rcmail.crm.$.progressIndicator();rcmail.crm.AppConnector.request({module:"AppComponents",view:"MailMessageAnalysisModal",content:content}).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),rcmail.crm.app.showModalWindow(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:"hide"}),rcmail.crm.app.showNotify({text:rcmail.crm.app.vtranslate("JS_ERROR"),type:"error"});});};
//# sourceMappingURL=preview.min.js.map
