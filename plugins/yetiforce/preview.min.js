

function loadActionBar(){var e=$("#ytActionBarContent"),o={module:"OSSMail",view:"MailActionBar",uid:rcmail.env.uid,folder:rcmail.env.mailbox,rcId:rcmail.env.user_id};window.crm.AppConnector.request(o).done(function(o){e.find(".ytHeader").html(o),$("#messagecontent").css("top",e.outerHeight()+$("#messageheader").outerHeight()+"px"),registerEvents(e)})}function registerEvents(e){registerAddRecord(e),registerAddReletedRecord(e),registerSelectRecord(e),registerRemoveRecord(e),registerImportMail(e);var o=e.find(".ytHeader .js-data");e.find(".hideBtn").click(function(){var e=$(this),t=e.find(".glyphicon");"0"==e.data("type")?(e.data("type","1"),t.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down")):(e.data("type","0"),t.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")),o.toggle(),$(window).trigger("resize")})}function registerImportMail(e){e.find(".importMail").click(function(e){window.crm.Vtiger_Helper_Js.showPnotify({text:window.crm.app.vtranslate("StartedDownloadingEmail"),type:"info"}),window.crm.AppConnector.request({module:"OSSMail",action:"ImportMail",params:{uid:rcmail.env.uid,folder:rcmail.env.mailbox,rcId:rcmail.env.user_id}}).done(function(e){loadActionBar(),window.crm.Vtiger_Helper_Js.showPnotify({text:window.crm.app.vtranslate("AddFindEmailInRecord"),type:"success"})})})}function registerRemoveRecord(e){e.find("button.removeRecord").click(function(e){removeRecord($(e.currentTarget).closest(".rowRelatedRecord").data("id"))})}function registerSelectRecord(e){let o=e.find("#mailActionBarID").val();e.find("button.selectRecord").click(function(e){let t={mailId:o};if(0==$(this).data("type"))var n=$(this).closest(".js-head-container").find(".module").val();else{n=$(this).data("module");t.crmid=$(this).closest(".rowRelatedRecord").data("id"),t.mod=$(this).closest(".rowRelatedRecord").data("module"),t.newModule=n}showPopup({module:n,src_module:"OSSMailView",src_record:o},t)})}function registerAddReletedRecord(e){e.find("#mailActionBarID").val();e.find("button.addRelatedRecord").click(function(e){var o=$(e.currentTarget),t=o.closest(".rowRelatedRecord"),n={sourceModule:t.data("module")};showQuickCreateForm(o.data("module"),t.data("id"),n)})}function registerAddRecord(e){var o=e.find("#mailActionBarID").val();e.find("button.addRecord").click(function(e){showQuickCreateForm($(e.currentTarget).closest(".js-head-container").find(".module").val(),o)})}function removeRecord(e){var o=$("#mailActionBarID").val(),t={};t.data={module:"OSSMail",action:"ExecuteActions",mode:"removeRelated",params:{mailId:o,crmid:e}},t.async=!1,t.dataType="json",window.crm.AppConnector.request(t).done(function(e){var o=e.result;if(o.success)var t={text:o.data,type:"info",animation:"show"};else t={text:o.data,animation:"show"};window.crm.Vtiger_Helper_Js.showPnotify(t),loadActionBar()})}function showPopup(e,o){o.newModule=e.module,window.crm.app.showRecordsList(e,(e,t)=>{t.setSelectEvent((e,t)=>{o.newCrmId=e.id,window.crm.AppConnector.request({async:!1,dataType:"json",data:{module:"OSSMail",action:"ExecuteActions",mode:"addRelated",params:o}}).done(function(e){let o=e.result;if(o.success)var t={text:o.data,type:"info",animation:"show"};else t={text:o.data,animation:"show"};window.crm.Vtiger_Helper_Js.showPnotify(t),loadActionBar()})})})}function showQuickCreateForm(e,o,t){var n=$("#ytActionBarContent");if(void 0==t)t={};var r={};if(t.sourceModule)var a=t.sourceModule;else a="OSSMailView";var i={link:"modulesLevel0",process:"modulesLevel1",subprocess:"modulesLevel2",linkextend:"modulesLevel3"};for(var c in i){var d=n.find("#"+i[c]),l=d.length?JSON.parse(d.val()):[];$.inArray(a,l)>=0&&(r[c]=o)}"Leads"==e&&(r.company=rcmail.env.fromName),"Leads"!=e&&"Contacts"!=e||(r.lastname=rcmail.env.fromName),"Project"==e&&(r.projectname=rcmail.env.subject),"HelpDesk"==e&&(r.ticket_title=rcmail.env.subject),"Products"==e&&(r.productname=rcmail.env.subject),"Services"==e&&(r.servicename=rcmail.env.subject),r.email=rcmail.env.fromMail,r.email1=rcmail.env.fromMail,r.description=$("#messagebody").text();r.sourceModule=a,r.sourceRecord=o,r.relationOperation=!0;var s={callbackFunction:function(e){loadActionBar()},callbackPostShown:function(e){$('<input type="hidden" name="sourceModule" value="'+a+'" />').appendTo(e),$('<input type="hidden" name="sourceRecord" value="'+o+'" />').appendTo(e),$('<input type="hidden" name="relationOperation" value="true" />').appendTo(e)},data:r,noCache:!0};(new window.crm.Vtiger_Header_Js).quickCreateModule(e,s)}function getCrmWindow(){return null!==opener&&"object"==opener.parent.CONFIG?opener.parent:"object"==typeof parent.CONFIG?parent:"object"==typeof parent.parent.CONFIG?parent.parent:"object"==typeof opener.crm.CONFIG&&opener.crm}window.rcmail&&rcmail.addEventListener("init",function(e){window.crm=getCrmWindow(),loadActionBar(),rcmail.env.message_commands.push("yetiforce.importICS"),rcmail.register_command("yetiforce.importICS",function(e,o,t){window.crm.AppConnector.request({async:!0,dataType:"json",data:{module:"Calendar",action:"ImportICS",ics:e}}).done(function(e){window.crm.Vtiger_Helper_Js.showPnotify({text:e.result,type:"info",animation:"show"}),$(o).closest(".icalattachments").remove()})},!0)});
//# sourceMappingURL=preview.min.js.map